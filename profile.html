<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Your existing CSS styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f3f3f3, #ddeafc);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
        }
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s ease-in-out;
            font-size: 14px;
            z-index: 1000; /* Ensures it stays on top */
        }
        .back-btn:hover {
            background: #0056b3;
        }

        .profile-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            width: 400px;
            animation: fadeIn 1s ease-in-out;
        }
        h2 {
            color: #333;
            margin-bottom: 15px;
        }
        .profile-pic {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid #007bff;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s ease-in-out;
        }
        .profile-pic:hover {
            transform: scale(1.05);
        }
        .profile-info {
            margin: 15px 0;
            text-align: left;
        }
        .profile-info label {
            font-weight: bold;
            color: #555;
        }
        .profile-info input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 16px;
        }
        .logout-btn {
            background: #ff4d4d;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s ease-in-out;
            margin-top: 15px;
            font-size: 16px;
        }
        .logout-btn:hover {
            background: #e63b3b;
        }
        .rating-stars span {
            font-size: 40px;
            cursor: pointer;
            transition: transform 0.3s ease-in-out, color 0.3s;
            display: inline-block;
        }
        .rating-stars span:hover,
        .rating-stars span.active {
            transform: scale(1.3);
            color: #ffcc00;
        }
        input[type="file"] {
            display: none;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="goToHome()">Back to Homepage</button>
    <script>
        function goToHome() {
        window.location.href = "HOME.html"; // Redirect to HOME.html
        }
    </script>

    <div class="profile-container">
        <h2>Welcome, <span id="user-name">User</span></h2>
        
        <!-- Profile Picture Upload -->
        <input type="file" id="profile-pic-upload" accept="image/*" onchange="uploadProfilePic(event)">
        <label for="profile-pic-upload">
            <img src="default-profile.png" id="profile-pic" class="profile-pic" alt="Profile Picture">
        </label>

        <!-- User Info -->
        <div class="profile-info">
            <label>Email:</label>
            <input type="text" id="user-email" readonly>
        </div>

        <!-- Rating System -->
        <div class="rating">
            <h3>Rate Our Website</h3>
            <div class="rating-stars">
                <span onclick="rate(1)">⭐</span>
                <span onclick="rate(2)">⭐</span>
                <span onclick="rate(3)">⭐</span>
                <span onclick="rate(4)">⭐</span>
                <span onclick="rate(5)">⭐</span>
            </div>
        </div>

        <!-- Logout Button -->
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <script>
        $(document).ready(function() {
            // Fetch user details from session
            $.ajax({
                url: 'get_user.php',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        $('#user-name').text(response.user.name);
                        $('#user-email').val(response.user.email);
                        sessionStorage.setItem("user_id", response.user.id);

                        // Load profile picture from sessionStorage
                        if (sessionStorage.getItem("profilePic")) {
                            $('#profile-pic').attr("src", sessionStorage.getItem("profilePic"));
                        }

                        // Load previous rating if exists
                        if (response.user.rating) {
                            highlightStars(response.user.rating);
                        }
                    } else {
                        alert("User not logged in.");
                        window.location.href = "login.html";
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching user details:", xhr.responseText);
                }
            });
        });

        // Star Rating System
        function rate(stars) {
            let userId = sessionStorage.getItem("user_id");
            let email = $('#user-email').val();

            // Validate data before sending
            if (!userId || !email || stars < 1 || stars > 5) {
                alert("Invalid data. Please ensure all fields are correctly filled.");
                return;
            }

            $.ajax({
                url: "save_rating.php",
                type: "POST",
                dataType: "json",
                data: {
                    user_id: userId,
                    email: email,
                    rating: stars
                },
                success: function(response) {
                    if (response.success) {
                        highlightStars(stars);
                        alert(response.message);
                    } else {
                        alert("Failed to save rating: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error submitting rating:", xhr.responseText);
                    alert("An error occurred while submitting your rating.");
                }
            });
        }

        // Highlight stars based on rating
        function highlightStars(stars) {
            $(".rating-stars span").removeClass("active");
            $(".rating-stars span:nth-child(-n+" + stars + ")").addClass("active");
        }

        // Profile Picture Upload
        function uploadProfilePic(event) {
            let file = event.target.files[0];
            if (file) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    $("#profile-pic").attr("src", e.target.result);
                    sessionStorage.setItem("profilePic", e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        // Logout Function
        function logout() {
            $.ajax({
                url: "logout.php",
                type: "GET",
                success: function() {
                    sessionStorage.clear();
                    alert("You have logged out!");
                    window.location.href = "login.html";
                },
                error: function(xhr, status, error) {
                    console.error("Logout error:", xhr.responseText);
                    alert("An error occurred during logout.");
                }
            });
        }
    </script>
</body>
</html>
